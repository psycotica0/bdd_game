<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8" />
    <title> Box Distribution Designer </title>
    <script src="node_modules/rx/dist/rx.lite.js"></script>
    <style>
      div.a {
        background: red;
        color: white;
      }
      div.b {
        background: blue;
        color: white;
      }
      div.c {
        background: yellow;
      }
    </style>
  </head>
  <body>
    <div id="1"> One </div>
    <div id="2"> Two </div>
    <div id="3"> Three </div>
    <div id="4"> Four </div>
    <div id="5"> Five </div>
    <div id="6"> Six </div>
    <div id="7"> Seven </div>

    <script>
      var initialSignal = new Rx.Subject();

      var updateSignal = new Rx.Observable.timer(2000, 2000);
      var updateDoneSignal = new Rx.Subject();

      var resolveSignal = updateDoneSignal.debounce(100);
      var resolveDoneSignal = new Rx.Subject();

      var commitSignal = resolveDoneSignal.debounce(100);

      function TestElement(id, full) {
        this.id = id;
        this.full = full;
        initialSignal.subscribe(this.setClass.bind(this));
        updateSignal.subscribe(this.moveNext.bind(this));
        resolveSignal.subscribe(this.resolve.bind(this));
        commitSignal.subscribe(this.commit.bind(this));
      }

      TestElement.prototype.setClass = function() {
        document.getElementById(this.id).setAttribute("class", this.full || "")
      }

      TestElement.prototype.moveNext = function() {
        if (this.full) {
          this.next.push(this.full)
          this.setNextStateDefault("full", false);
        }
        updateDoneSignal.onNext({});
      }

      TestElement.prototype.setNextState = function(key, value) {
        this.nextState = this.nextState || {}
        this.nextState[key] = value
      }

      TestElement.prototype.setNextStateDefault = function(key, value) {
        this.nextState = this.nextState || {}
        if (this.nextState[key] === undefined) {
          this.nextState[key] = value
        }
      }

      TestElement.prototype.push = function(item, sender) {
        this.setNextState("full", item)
        this.setNextState("sender", sender)
      }

      TestElement.prototype.resolve = function() {
        resolveDoneSignal.onNext({});
      }

      TestElement.prototype.commit = function() {
        for (key in this.nextState) {
          this[key] = this.nextState[key]
        }
        this.nextState = undefined
        this.setClass();
      }

      var i1 = new TestElement("1", "a");
      var i2 = new TestElement("2", "b");
      i1.next = i2
      var i3 = new TestElement("3", false);
      i2.next = i3
      var i4 = new TestElement("4", "c");
      i3.next = i4
      var i5 = new TestElement("5", false);
      i4.next = i5
      var i6 = new TestElement("6", false);
      i5.next = i6
      var i7 = new TestElement("7", false);
      i6.next = i7
      i7.next = i1

      initialSignal.onNext({})
    </script>
  </body>
</html>
